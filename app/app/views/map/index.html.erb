<style>
  #map {width:100%; height:500px; margin-bottom:40px;}
  #left-nav{height:500px;}
  select{width:100%;}
</style>

<div class="row">

<div id="left-nav" class="span2">
  <h2>Filters</h2>

  <label>City</label>
  <select id="input-city">
    <option value="Charlotte">Charlotte</option>
    <option value="Las Vegas">Las Vegas</option>
    <option value="Madison">Madison</option>
    <option value="Montreal">Montreal</option>
    <option value="Phoenix">Phoenix</option>
    <option value="Pittsburgh">Pittsburgh</option>
  </select>

  <br><br>

  <label>Category</label>
  <select id="input-category" multiple="multiple"></select>

  <br><br>
  
  <label>Attribute</label>
  <select id="input-attr" multiple="multiple"></select>

  <br><br><br>

  <div class="text-center">
    <button id="search-btn" class="btn btn-primary"><i class="fa fa-search"></i> Search</button>
  </div>

  <br>

  <p><a onclick="useCurrentLocation()"><i class="fa fa-map-marker"></i> Current Location</a></p>
  <p><a><i class="fa fa-save"></i> Save Search</a></p>
  <p><a><i class="fa fa-upload"></i> Load Search</a></p>

</div>

<div class="span10">
  <div id="map"></div>
</div>

</div> <!-- /.row -->

<script>

var results = [];
var map = {};
var heatmapLayer = {};
var markerLayer = {};
var dataZoom = 11;
var zoomThreshold = 13;

var plotData = function () {
  var arr = [];
  $.each(results, function (index, business) {
    arr.push(
      L.marker([business.latitude, business.longitude], {icon: new L.Icon.Default})
      .bindPopup('<p class="lead">' + business.name + '</p>' +
        '<p>' + business.full_address + '</p>'
      )
    );
  });
  markerLayer = L.layerGroup(arr);
};

var plotHeatData = function () {
  var businesses = {
    max: 1,
    data: results
  };

  heatmapLayer.setData(businesses);
};

var getData = function () {

  var formData = {};
  formData.city = $('#input-city').val();
  formData.categories = $('#input-category').val() || [];
  formData.attributes = $('#input-attr').val() || [];

  //console.log(formData);

  $.getJSON('/businesses.json', formData, function (data) {
    results = data;
    plotHeatData();
  });

};

$(document).ready(function() {

  var baseLayer = L.tileLayer(
    'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
      maxZoom: 18
    }
  );

  var cfg = {
    "radius": 0.01,
    "maxOpacity": .8, 
    "scaleRadius": true,
    "blur": 0.9,
    "useLocalExtrema": false,
    latField: 'latitude',
    lngField: 'longitude',
    valueField: 'rating'
  };

  heatmapLayer = new HeatmapOverlay(cfg);

  map = new L.Map('map', {
    center: new L.LatLng(39.8282, -98.5795),
    zoom: 4,
    layers: [baseLayer, heatmapLayer]
  });

  map.on('zoomend', function () {
    if (map.getZoom() > zoomThreshold) {
      if (map.hasLayer(heatmapLayer)) map.removeLayer(heatmapLayer);
      if (! map.hasLayer(markerLayer)) {
        plotData();
        map.addLayer(markerLayer);
      }
    } else {
      if (map.hasLayer(markerLayer)) map.removeLayer(markerLayer);
      if (! map.hasLayer(heatmapLayer)) {
        plotHeatData();
        map.addLayer(heatmapLayer);
      }
    }   
  });

  $('#search-btn').click(function() {
    getData();
    map.setView([results[0].latitude, results[0].longitude], dataZoom);
  });

  $.getJSON('/categories.json', function(data) {
	  $.each(data, function(key, value) {
      $('#input-category').append($('<option>', {
        value: value.category_id,
        text: value.name
	    }));
	  });
	  $('#input-category').multiselect();
   });
 
  $.getJSON("/zattributes.json", function(data) {
    $.each(data, function(key, value) {   
      $('#input-attr').append($('<option>', {
        value: value.attribute_id,
        text: value.attribute_name
      }));
    });
    $('#input-attr').multiselect();
  });

});

var useCurrentLocation = function () {
  navigator.geolocation.getCurrentPosition(function (data) {
    var BlueIcon = L.Icon.Default;
    map.setView([data.coords.latitude, data.coords.longitude], dataZoom + 3);
    L.marker([data.coords.latitude, data.coords.longitude], {icon: new L.Icon.Default})
     .addTo(map)
     .bindPopup('<h5>You are here.</h5>')
     .openPopup();
  });
};

</script>

